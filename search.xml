<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title></title>
    <url>/%E6%96%B0%E5%BB%BA%20Markdown/</url>
    <content><![CDATA[<p>AAA</p>
]]></content>
  </entry>
  <entry>
    <title>获取基因长度计算FPKM_TPM</title>
    <url>/20230107_%E8%8E%B7%E5%8F%96%E5%9F%BA%E5%9B%A0%E9%95%BF%E5%BA%A6%E8%AE%A1%E7%AE%97FPKM_TPM/20230107_%E8%8E%B7%E5%8F%96%E5%9F%BA%E5%9B%A0%E9%95%BF%E5%BA%A6%E8%AE%A1%E7%AE%97FPKM_TPM/</url>
    <content><![CDATA[<p><strong>主要内容</strong></p>
<ul>
<li>使用GenomicFeatures读取GTF文件，获取基因长度信息</li>
<li>使用counts2FPKM函数 counts2TPM函数 将counts矩阵变化为FPKM TPM</li>
</ul>
<span id="more"></span>

<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">library<span class="punctuation">(</span>parallel<span class="punctuation">)</span>         <span class="comment">#并行计算  parApply parLapply parSaplly </span></span><br><span class="line">library<span class="punctuation">(</span>GenomicFeatures<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>dplyr<span class="punctuation">)</span></span><br><span class="line">options<span class="punctuation">(</span>max.print <span class="operator">=</span> <span class="number">10</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<h2 id="使用GTF文件获取基因长度信息"><a href="#使用GTF文件获取基因长度信息" class="headerlink" title="使用GTF文件获取基因长度信息"></a>使用GTF文件获取基因长度信息</h2><p>参考: <a href="https://mp.weixin.qq.com/s/VsVDZPeJiNqwXUgj0mOVVA">https://mp.weixin.qq.com/s/VsVDZPeJiNqwXUgj0mOVVA</a></p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">cl <span class="operator">&lt;-</span> makeCluster<span class="punctuation">(</span><span class="number">0.75</span><span class="operator">*</span>detectCores<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">)</span>  <span class="comment">#设计启用计算机3/4的核</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 利用GenomicFeatures包导入gtf处理</span></span><br><span class="line">txdb <span class="operator">&lt;-</span> makeTxDbFromGFF<span class="punctuation">(</span><span class="string">&quot;../../post_share_data/Mus_musculus.GRCm39.108.gtf.gz&quot;</span><span class="punctuation">,</span></span><br><span class="line">                        format<span class="operator">=</span><span class="string">&quot;gtf&quot;</span><span class="punctuation">)</span> </span><br><span class="line"></span><br><span class="line"><span class="comment">## 提取基因外显子</span></span><br><span class="line">exons_gene <span class="operator">&lt;-</span> exonsBy<span class="punctuation">(</span>txdb<span class="punctuation">,</span> by <span class="operator">=</span> <span class="string">&quot;gene&quot;</span><span class="punctuation">)</span> </span><br><span class="line">head<span class="punctuation">(</span>exons_gene<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 计算总外显子长度：用reduce去除掉重叠冗余的部分，,width统计长度，最后计算总长度</span></span><br><span class="line">exons_gene_lens <span class="operator">&lt;-</span> parLapply<span class="punctuation">(</span>cl<span class="punctuation">,</span>exons_gene<span class="punctuation">,</span><span class="keyword">function</span><span class="punctuation">(</span>x<span class="punctuation">)</span><span class="punctuation">&#123;</span><span class="built_in">sum</span><span class="punctuation">(</span>width<span class="punctuation">(</span>reduce<span class="punctuation">(</span>x<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">&#125;</span><span class="punctuation">)</span> </span><br><span class="line">exons_gene_lens<span class="punctuation">[</span><span class="number">1</span><span class="operator">:</span><span class="number">10</span><span class="punctuation">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##转换为dataframe</span></span><br><span class="line">geneid_efflen <span class="operator">&lt;-</span> data.frame<span class="punctuation">(</span>geneid<span class="operator">=</span><span class="built_in">names</span><span class="punctuation">(</span>exons_gene_lens<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                            efflen<span class="operator">=</span><span class="built_in">as.numeric</span><span class="punctuation">(</span>exons_gene_lens<span class="punctuation">)</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<p>一列为基因名ENSEMBL ID 一列为基因长度</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">load<span class="punctuation">(</span><span class="string">&quot;../../../post_share_data/geneid_efflen_Mus_GRCm39_108.RData&quot;</span><span class="punctuation">)</span></span><br><span class="line">head<span class="punctuation">(</span>geneid_efflen<span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<pre><code>#&gt;               geneid efflen
#&gt; 1 ENSMUSG00000000001   3262
#&gt; 2 ENSMUSG00000000003    902
#&gt; 3 ENSMUSG00000000028   3506
#&gt; 4 ENSMUSG00000000031   2625
#&gt; 5 ENSMUSG00000000037   6397
#&gt;  [ reached &#39;max&#39; / getOption(&quot;max.print&quot;) -- omitted 1 rows ]
</code></pre>
<h2 id="counts转FPKM"><a href="#counts转FPKM" class="headerlink" title="counts转FPKM"></a>counts转FPKM</h2><p>参考: <a href="https://mp.weixin.qq.com/s/IUV9dSbRBK1nvetixKOCRw">Counts FPKM RPKM TPM CPM 的转化 (qq.com)</a></p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">load<span class="punctuation">(</span><span class="string">&quot;../../../post_share_data/counts_dat.RData&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">counts_dat_id <span class="operator">&lt;-</span> rownames<span class="punctuation">(</span>counts_dat<span class="punctuation">)</span></span><br><span class="line">geneid_efflen_geneid <span class="operator">&lt;-</span> geneid_efflen<span class="operator">$</span>geneid</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取共有id</span></span><br><span class="line">comm_id <span class="operator">&lt;-</span> intersect<span class="punctuation">(</span>counts_dat_id<span class="punctuation">,</span>geneid_efflen_geneid<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 过滤，id排序 保持id顺序一致</span></span><br><span class="line">geneid_efflen <span class="operator">&lt;-</span> geneid_efflen<span class="punctuation">[</span>geneid_efflen<span class="operator">$</span>geneid <span class="operator">%in%</span> comm_id<span class="punctuation">,</span><span class="punctuation">]</span></span><br><span class="line">comm_id <span class="operator">&lt;-</span> geneid_efflen<span class="operator">$</span>geneid</span><br><span class="line">counts_dat <span class="operator">&lt;-</span> counts_dat<span class="punctuation">[</span>comm_id<span class="punctuation">,</span><span class="punctuation">]</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># count--counts表达矩阵，efflength基因长度向量 基因和长度要对应</span></span><br><span class="line"><span class="comment"># geneid_efflen--第一列为geneid 第二列为efflen</span></span><br><span class="line">counts2FPKM <span class="operator">&lt;-</span> <span class="keyword">function</span><span class="punctuation">(</span>count<span class="punctuation">,</span> geneid_efflen<span class="punctuation">)</span><span class="punctuation">&#123;</span>    </span><br><span class="line">  </span><br><span class="line">  library<span class="punctuation">(</span>purrr<span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  counts_id <span class="operator">&lt;-</span> rownames<span class="punctuation">(</span>count<span class="punctuation">)</span></span><br><span class="line">  geneid_efflen_geneid <span class="operator">&lt;-</span> geneid_efflen<span class="operator">$</span>geneid</span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 获取共有id</span></span><br><span class="line">  comm_id <span class="operator">&lt;-</span> intersect<span class="punctuation">(</span>counts_id<span class="punctuation">,</span>geneid_efflen_geneid<span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 过滤，id排序 保持id顺序一致</span></span><br><span class="line">  geneid_efflen <span class="operator">&lt;-</span> geneid_efflen<span class="punctuation">[</span>geneid_efflen<span class="operator">$</span>geneid <span class="operator">%in%</span> comm_id<span class="punctuation">,</span><span class="punctuation">]</span></span><br><span class="line">  comm_id <span class="operator">&lt;-</span> geneid_efflen<span class="operator">$</span>geneid</span><br><span class="line">  count <span class="operator">&lt;-</span> count<span class="punctuation">[</span>comm_id<span class="punctuation">,</span><span class="punctuation">]</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 基因长度向量</span></span><br><span class="line">  efflength <span class="operator">=</span> geneid_efflen<span class="operator">$</span>efflen</span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 函数对每一个样本做FPKM</span></span><br><span class="line">  f <span class="operator">&lt;-</span> <span class="keyword">function</span><span class="punctuation">(</span>count_one<span class="punctuation">,</span>efflength<span class="punctuation">)</span><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="comment"># counts的每百万缩放因子 (“per million” scaling factor) 深度标准化   </span></span><br><span class="line">  PMSC_counts <span class="operator">&lt;-</span> <span class="built_in">sum</span><span class="punctuation">(</span>count_one<span class="punctuation">)</span><span class="operator">/</span><span class="number">1e6</span>   </span><br><span class="line">  <span class="comment"># 每百万reads/Fragments (Reads/Fragments Per Million) 长度标准化  </span></span><br><span class="line">  FPM <span class="operator">&lt;-</span> count_one<span class="operator">/</span>PMSC_counts         </span><br><span class="line">  FPM<span class="operator">/</span><span class="punctuation">(</span>efflength<span class="operator">/</span><span class="number">1000</span><span class="punctuation">)</span>   </span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 对全部样本做FPKM</span></span><br><span class="line">  FPKM_data <span class="operator">&lt;-</span> map_dfc<span class="punctuation">(</span>count<span class="punctuation">,</span>f<span class="punctuation">,</span>efflength<span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="built_in">return</span><span class="punctuation">(</span>FPKM_data<span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line"><span class="punctuation">&#125;</span> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">FPKM <span class="operator">&lt;-</span> counts2FPKM<span class="punctuation">(</span>count <span class="operator">=</span> counts_dat<span class="punctuation">,</span>geneid_efflen <span class="operator">=</span> geneid_efflen<span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<pre><code>#&gt; 
#&gt; Attaching package: &#39;purrr&#39;

#&gt; The following object is masked from &#39;package:GenomicRanges&#39;:
#&gt; 
#&gt;     reduce

#&gt; The following object is masked from &#39;package:IRanges&#39;:
#&gt; 
#&gt;     reduce
</code></pre>
<h2 id="counts转TPM"><a href="#counts转TPM" class="headerlink" title="counts转TPM"></a>counts转TPM</h2><figure class="highlight r"><table><tr><td class="code"><pre><span class="line">counts2TPM <span class="operator">&lt;-</span> <span class="keyword">function</span><span class="punctuation">(</span>count<span class="punctuation">,</span> geneid_efflen<span class="punctuation">)</span><span class="punctuation">&#123;</span>   </span><br><span class="line">  </span><br><span class="line">  library<span class="punctuation">(</span>purrr<span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  counts_id <span class="operator">&lt;-</span> rownames<span class="punctuation">(</span>count<span class="punctuation">)</span></span><br><span class="line">  geneid_efflen_geneid <span class="operator">&lt;-</span> geneid_efflen<span class="operator">$</span>geneid</span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 获取共有id</span></span><br><span class="line">  comm_id <span class="operator">&lt;-</span> intersect<span class="punctuation">(</span>counts_id<span class="punctuation">,</span>geneid_efflen_geneid<span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 过滤，id排序 保持id顺序一致</span></span><br><span class="line">  geneid_efflen <span class="operator">&lt;-</span> geneid_efflen<span class="punctuation">[</span>geneid_efflen<span class="operator">$</span>geneid <span class="operator">%in%</span> comm_id<span class="punctuation">,</span><span class="punctuation">]</span></span><br><span class="line">  comm_id <span class="operator">&lt;-</span> geneid_efflen<span class="operator">$</span>geneid</span><br><span class="line">  count <span class="operator">&lt;-</span> count<span class="punctuation">[</span>comm_id<span class="punctuation">,</span><span class="punctuation">]</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 基因长度向量</span></span><br><span class="line">  efflength <span class="operator">=</span> geneid_efflen<span class="operator">$</span>efflen</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">  <span class="comment"># 函数对每一个样本做FPKM</span></span><br><span class="line">  f <span class="operator">&lt;-</span> <span class="keyword">function</span><span class="punctuation">(</span>count_one<span class="punctuation">,</span>efflength<span class="punctuation">)</span><span class="punctuation">&#123;</span></span><br><span class="line">    </span><br><span class="line">  <span class="comment">#每千碱基reads (reads per kilobase) 长度标准化</span></span><br><span class="line">  RPK <span class="operator">&lt;-</span> count_one<span class="operator">/</span><span class="punctuation">(</span>efflength<span class="operator">/</span><span class="number">1000</span><span class="punctuation">)</span>      </span><br><span class="line">  <span class="comment">#RPK的每百万缩放因子 (“per million” scaling factor ) 深度标准化</span></span><br><span class="line">  PMSC_rpk <span class="operator">&lt;-</span> <span class="built_in">sum</span><span class="punctuation">(</span>RPK<span class="punctuation">)</span><span class="operator">/</span><span class="number">1e6</span>           </span><br><span class="line">  RPK<span class="operator">/</span>PMSC_rpk</span><br><span class="line">    </span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 对全部样本做FPKM</span></span><br><span class="line">  TPM_data <span class="operator">&lt;-</span> map_dfc<span class="punctuation">(</span>count<span class="punctuation">,</span>f<span class="punctuation">,</span>efflength<span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="built_in">return</span><span class="punctuation">(</span>TPM_data<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#125;</span>    </span><br><span class="line"></span><br><span class="line">TPM <span class="operator">&lt;-</span> counts2TPM<span class="punctuation">(</span>count <span class="operator">=</span> counts_dat<span class="punctuation">,</span>geneid_efflen <span class="operator">=</span> geneid_efflen<span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<h2 id="FPKM转TPM"><a href="#FPKM转TPM" class="headerlink" title="FPKM转TPM"></a>FPKM转TPM</h2><figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="comment">#FPKM与TPM的转化 </span></span><br><span class="line">FPKM2TPM <span class="operator">&lt;-</span> <span class="keyword">function</span><span class="punctuation">(</span>fpkm<span class="punctuation">)</span><span class="punctuation">&#123;</span></span><br><span class="line">  library<span class="punctuation">(</span>purrr<span class="punctuation">)</span></span><br><span class="line">  TPM_data <span class="operator">&lt;-</span> map_dfc<span class="punctuation">(</span>fpkm<span class="punctuation">,</span><span class="operator">~</span> .x<span class="operator">/</span><span class="built_in">sum</span><span class="punctuation">(</span>.x<span class="punctuation">)</span><span class="operator">*</span><span class="number">1e6</span>   <span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span> </span><br><span class="line"></span><br><span class="line">TPM2 <span class="operator">&lt;-</span> FPKM2TPM<span class="punctuation">(</span>fpkm <span class="operator">=</span> FPKM<span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>RNA-seq</category>
      </categories>
      <tags>
        <tag>RNA-seq</tag>
      </tags>
  </entry>
  <entry>
    <title>20230111_获取基因注释信息</title>
    <url>/RNA-seq/20230111_%E8%8E%B7%E5%8F%96%E5%9F%BA%E5%9B%A0%E6%B3%A8%E9%87%8A%E4%BF%A1%E6%81%AF/20230111_%E8%8E%B7%E5%8F%96%E5%9F%BA%E5%9B%A0%E6%B3%A8%E9%87%8A%E4%BF%A1%E6%81%AF/</url>
    <content><![CDATA[<p><strong>要点：</strong></p>
<ul>
<li><p>rtracklayer包读取GTF</p>
</li>
<li><p>biomaRt</p>
</li>
</ul>
<span id="more"></span>

<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">library<span class="punctuation">(</span>rtracklayer<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>biomaRt<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>tidyverse<span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<h2 id="使用rtracklayer包通过GTF文件获取基因注释信息"><a href="#使用rtracklayer包通过GTF文件获取基因注释信息" class="headerlink" title="使用rtracklayer包通过GTF文件获取基因注释信息"></a>使用rtracklayer包通过GTF文件获取基因注释信息</h2><figure class="highlight r"><table><tr><td class="code"><pre><span class="line">gtf <span class="operator">=</span> import<span class="punctuation">(</span><span class="string">&quot;../../../../post_share_data/Mus_musculus.GRCm39.108.test.gtf.gz&quot;</span><span class="punctuation">,</span>format <span class="operator">=</span> <span class="string">&quot;GTF&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">gtf_df <span class="operator">&lt;-</span> as.data.frame<span class="punctuation">(</span>gtf<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 只选择基因的行</span></span><br><span class="line">gtf_df_gene <span class="operator">&lt;-</span> gtf_df <span class="operator">%&gt;%</span> filter<span class="punctuation">(</span>type <span class="operator">==</span> <span class="string">&quot;gene&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取想要的注释信息</span></span><br><span class="line">gene_annotate <span class="operator">&lt;-</span> gtf_df_gene<span class="punctuation">[</span><span class="punctuation">,</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;seqnames&quot;</span><span class="punctuation">,</span><span class="string">&quot;start&quot;</span><span class="punctuation">,</span><span class="string">&quot;end&quot;</span><span class="punctuation">,</span><span class="string">&quot;strand&quot;</span><span class="punctuation">,</span><span class="string">&quot;gene_id&quot;</span><span class="punctuation">,</span><span class="string">&quot;gene_name&quot;</span><span class="punctuation">,</span><span class="string">&quot;gene_biotype&quot;</span><span class="punctuation">)</span><span class="punctuation">]</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">gene_annotate<span class="punctuation">[</span><span class="number">1</span><span class="operator">:</span><span class="number">3</span><span class="punctuation">,</span><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>

<h2 id="使用biomaRt包获取基因注释信息"><a href="#使用biomaRt包获取基因注释信息" class="headerlink" title="使用biomaRt包获取基因注释信息"></a>使用biomaRt包获取基因注释信息</h2><figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ensembl <span class="operator">&lt;-</span> useEnsembl<span class="punctuation">(</span>biomart <span class="operator">=</span> <span class="string">&quot;genes&quot;</span><span class="punctuation">)</span></span><br><span class="line">Datasets <span class="operator">&lt;-</span> listDatasets<span class="punctuation">(</span>ensembl<span class="punctuation">)</span></span><br><span class="line">ensembl <span class="operator">&lt;-</span> useDataset<span class="punctuation">(</span>dataset <span class="operator">=</span> <span class="string">&quot;mmusculus_gene_ensembl&quot;</span><span class="punctuation">,</span> mart <span class="operator">=</span> ensembl<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">ensembl_id <span class="operator">&lt;-</span> gene_annotate<span class="operator">$</span>gene_id</span><br><span class="line"></span><br><span class="line"><span class="built_in">length</span><span class="punctuation">(</span>ensembl_id<span class="punctuation">)</span></span><br><span class="line"><span class="comment"># listAttributes(ensembl) %&gt;% View()</span></span><br><span class="line">gene_annotate2 <span class="operator">&lt;-</span> getBM<span class="punctuation">(</span><span class="built_in">attributes</span><span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span> <span class="string">&quot;chromosome_name&quot;</span><span class="punctuation">,</span><span class="string">&#x27;ensembl_gene_id&#x27;</span><span class="punctuation">,</span> <span class="string">&quot;external_gene_name&quot;</span><span class="punctuation">,</span><span class="string">&quot;gene_biotype&quot;</span><span class="punctuation">,</span><span class="string">&quot;start_position&quot;</span><span class="punctuation">,</span><span class="string">&quot;end_position&quot;</span><span class="punctuation">,</span><span class="string">&quot;description&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span> </span><br><span class="line">                    filters<span class="operator">=</span> <span class="string">&#x27;ensembl_gene_id&#x27;</span><span class="punctuation">,</span> value <span class="operator">=</span>ensembl_id<span class="punctuation">,</span> mart <span class="operator">=</span> ensembl<span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>RNA-seq</category>
      </categories>
      <tags>
        <tag>RNA-seq</tag>
      </tags>
  </entry>
</search>
